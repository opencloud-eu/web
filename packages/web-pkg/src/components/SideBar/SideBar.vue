<template>
  <div
    id="app-sidebar"
    ref="appSideBar"
    data-testid="app-sidebar"
    tabindex="-1"
    class="border-l focus:outline-0 focus-visible:outline-0 w-[440px] min-w-[440px] overflow-hidden relative"
    :class="{
      'has-active-sub-panel': hasActiveSubPanel,
      'flex justify-center items-center': loading,
      'app-sidebar-full-width w-full min-w-full': fullWidthSideBar
    }"
  >
    <oc-spinner v-if="loading" />
    <template v-else>
      <div
        v-for="panel in displayPanels"
        :id="`sidebar-panel-${panel.name}`"
        :key="`panel-${panel.name}`"
        :data-testid="`sidebar-panel-${panel.name}`"
        :tabindex="activePanelName === panel.name ? -1 : null"
        class="sidebar-panel absolute top-0 grid grid-rows-[auto_auto_1fr] bg-role-surface rounded-r-xl w-full size-full max-w-full max-h-full overflow-hidden"
        :inert="activePanelName !== panel.name"
        :class="{
          'is-root-panel': panel.isRoot?.(panelContext),
          'is-active-sub-panel': hasActiveSubPanel && activeSubPanelName === panel.name, // only one specific sub panel can be active
          'is-active-root-panel': hasActiveRootPanel && panel.isRoot?.(panelContext) // all root panels are active if no sub panel is active
        }"
      >
        <div
          v-if="[activePanelName, oldPanelName].includes(panel.name)"
          class="sidebar-panel__header header grid grid-cols-[auto_1fr_auto] items-center pt-2 px-2"
        >
          <oc-button
            v-if="!panel.isRoot?.(panelContext)"
            v-oc-tooltip="accessibleLabelBack"
            class="header__back col-start-1 p-1"
            appearance="raw"
            :aria-label="accessibleLabelBack"
            @click="closePanel"
          >
            <oc-icon name="arrow-left-s" fill-type="line" />
          </oc-button>

          <h2 class="header__title col-start-2 text-center my-0 text-lg">
            {{ panel.title(panelContext) }}
          </h2>

          <oc-button
            appearance="raw"
            class="header__close col-start-3 p-1"
            :aria-label="$gettext('Close file sidebar')"
            @click="closeSidebar"
          >
            <oc-icon name="close" />
          </oc-button>
        </div>

        <div>
          <slot v-if="panel.isRoot?.(panelContext)" name="rootHeader" />
          <slot v-else name="subHeader" />
        </div>
        <div
          class="sidebar-panel__body flex flex-col p-2 overflow-y-auto overflow-x-hidden"
          :class="[`sidebar-panel__body-${panel.name}`]"
        >
          <div
            class="sidebar-panel__body-content"
            :class="{
              'sidebar-panel__body-content-stretch flex-1 ': !panel.isRoot?.(panelContext)
            }"
          >
            <slot name="body">
              <div
                v-for="(p, index) in panel.isRoot?.(panelContext) ? rootPanels : [panel]"
                :key="`sidebar-panel-${p.name}`"
              >
                <component
                  :is="p.component"
                  v-if="
                    hasActiveRootPanel
                      ? p.isRoot?.(panelContext)
                      : [activePanelName, oldPanelName].includes(p.name)
                  "
                  :class="{ 'multi-root-panel-separator mt-4 pt-2 border-t': index > 0 }"
                  class="rounded-sm"
                  v-bind="p.componentAttrs?.(panelContext) || {}"
                />
              </div>
            </slot>
          </div>

          <div
            v-if="panel.isRoot?.(panelContext) && subPanels.length > 0"
            class="sidebar-panel__navigation mt-4"
          >
            <oc-button
              v-for="panelSelect in subPanels"
              :id="`sidebar-panel-${panelSelect.name}-select`"
              :key="`panel-select-${panelSelect.name}`"
              :data-testid="`sidebar-panel-${panelSelect.name}-select`"
              appearance="raw-inverse"
              color-role="surface"
              class="!grid !grid-cols-[auto_1fr_auto] text-left px-2 w-full h-12"
              @click="openPanel(panelSelect.name)"
            >
              <oc-icon :name="panelSelect.icon" :fill-type="panelSelect.iconFillType" />
              {{ panelSelect.title(panelContext) }}
              <oc-icon name="arrow-right-s" fill-type="line" />
            </oc-button>
          </div>
        </div>
      </div>
    </template>
  </div>
</template>

<script setup lang="ts">
import {
  computed,
  nextTick,
  onBeforeUnmount,
  onMounted,
  ref,
  unref,
  useTemplateRef,
  watch
} from 'vue'
import { SideBarPanel, SideBarPanelContext } from './types'
import { useGettext } from 'vue3-gettext'

const {
  isOpen,
  loading,
  availablePanels,
  panelContext,
  activePanel = ''
} = defineProps<{
  isOpen: boolean
  loading: boolean
  availablePanels: SideBarPanel<unknown, unknown, unknown>[]
  panelContext: SideBarPanelContext<unknown, unknown, unknown>
  activePanel?: string
}>()

const emit = defineEmits<{
  (e: 'selectPanel', panel: string): void
  (e: 'close'): void
}>()

defineSlots<{
  body: () => unknown
  rootHeader: () => unknown
  subHeader: () => unknown
}>()

const { $gettext } = useGettext()
const appSideBar = useTemplateRef<HTMLElement>('appSideBar')

const rootPanels = computed(() => {
  return availablePanels.filter((p) => p.isVisible(panelContext) && p.isRoot?.(panelContext))
})
const subPanels = computed(() =>
  availablePanels.filter((p) => p.isVisible(panelContext) && !p.isRoot?.(panelContext))
)
const displayPanels = computed<SideBarPanel<unknown, unknown, unknown>[]>(() => {
  if (unref(rootPanels).length) {
    return [unref(rootPanels)[0], ...unref(subPanels)]
  }
  return unref(subPanels)
})

const activeSubPanelName = computed(() => {
  const panelName = activePanel?.split('#')[0]
  if (!panelName) {
    return null
  }
  if (
    !unref(subPanels)
      .map((p) => p.name)
      .includes(panelName)
  ) {
    return null
  }
  return panelName
})
const hasActiveSubPanel = computed(() => {
  return unref(activeSubPanelName) !== null
})
const hasActiveRootPanel = computed(() => {
  return unref(activeSubPanelName) === null
})

const oldPanelName = ref<string>(null)
const setOldPanelName = (name: string) => {
  oldPanelName.value = name
}
const activePanelName = computed<string>(() => {
  if (unref(hasActiveSubPanel)) {
    return unref(activeSubPanelName)
  }
  return unref(rootPanels)[0].name
})

const accessibleLabelBack = computed(() => {
  if (unref(rootPanels).length === 1) {
    return $gettext('Back to %{panel} panel', {
      panel: unref(rootPanels)[0].title(panelContext)
    })
  }
  return $gettext('Back to main panels')
})

const windowWidth = ref(window.innerWidth)

const fullWidthSideBar = computed(() => unref(windowWidth) <= 580)
const backgroundContentEl = computed(() => {
  return unref(appSideBar)?.parentElement?.querySelector('div')
})

const handleBackgroundContentVisibility = () => {
  // handles the visibility of the content behind the sidebar. It needs to be hidden if
  // the sidebar is open and has full width to avoid focusable elements.
  if (!unref(backgroundContentEl)) {
    return
  }

  const visibility = unref(fullWidthSideBar) ? 'hidden' : 'visible'
  unref(backgroundContentEl).style.visibility = visibility
}

const onResize = () => {
  if (!isOpen) {
    return
  }

  windowWidth.value = window.innerWidth
  handleBackgroundContentVisibility()
}

watch(
  () => isOpen,
  async (isOpen) => {
    if (!isOpen) {
      return
    }
    await nextTick()
    handleBackgroundContentVisibility()
  },
  { immediate: true }
)

const setSidebarPanel = (panel: string) => {
  emit('selectPanel', panel)
}

const resetSidebarPanel = () => {
  emit('selectPanel', null)
}

const closeSidebar = () => {
  emit('close')
}

const openPanel = (panel: string) => {
  setOldPanelName(unref(activePanelName))
  setSidebarPanel(panel)
}

const closePanel = () => {
  setOldPanelName(unref(activePanelName))
  resetSidebarPanel()
  unref(appSideBar).focus()
}

onMounted(() => {
  window.addEventListener('resize', onResize)
})

onBeforeUnmount(() => {
  window.removeEventListener('resize', onResize)

  if (unref(backgroundContentEl)) {
    unref(backgroundContentEl).style.visibility = 'visible'
  }
})
</script>
<style>
@reference '@opencloud-eu/design-system/tailwind';

@layer components {
  .sidebar-panel {
    transform: translateX(100%);
  }
  .sidebar-panel.is-root-panel {
    right: 100px;
  }
}

@layer utilities {
  .sidebar-panel.is-active-root-panel {
    @apply right-0;
  }
  .sidebar-panel.is-active-root-panel,
  .sidebar-panel.is-active-sub-panel,
  .sidebar-panel.is-root-panel {
    transform: translateX(0);
  }
}
</style>
<style lang="scss">
#app-sidebar {
  &:focus,
  &:focus-visible {
    box-shadow: none;
  }
}

@media only screen and (max-width: $oc-breakpoint-small-default) {
  .files-wrapper {
    flex-wrap: nowrap !important;
  }
}

.sidebar-panel {
  $root: &;
  transition:
    transform 0.4s ease,
    visibility 0.4s 0s;
  // visibility is here to prevent focusing panel child elements,
  // the transition delay keeps care that it will only apply if the element is visible or not.
  // hidden: if element is off screen
  // visible: if element is on screen
  visibility: hidden;

  @media screen and (prefers-reduced-motion: reduce), (update: slow) {
    transition-duration: 0.001ms !important;
  }

  &.is-active-root-panel,
  &.is-active-sub-panel {
    visibility: unset;
  }

  &.is-active-root-panel {
    transition: right 0.4s 0s;
  }

  &.is-root-panel {
    visibility: visible;
    transition: right 0.4s 0s;
  }
}
</style>
